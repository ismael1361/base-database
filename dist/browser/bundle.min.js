(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.PocketSafe=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Custom=void 0;class Custom{_disconnected=false;database;constructor(database){this.database=this.connect(database)}get disconnected(){return this._disconnected}set disconnected(value){this._disconnected=value;if(value)this.disconnect()}async ready(callback){if(this._disconnected)throw new Error("Database is disconnected");const db=await this.database;return callback?await callback(db):undefined}}exports.Custom=Custom},{}],2:[function(require,module,exports){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __exportStar=this&&this.__exportStar||function(m,exports){for(var p in m)if(p!=="default"&&!Object.prototype.hasOwnProperty.call(exports,p))__createBinding(exports,m,p)};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Database=void 0;const basic_event_emitter_1=__importDefault(require("basic-event-emitter"));const Table_1=require("./Table");__exportStar(require("./Types"),exports);__exportStar(require("./Utils"),exports);__exportStar(require("./Custom"),exports);__exportStar(require("./Table"),exports);class Database extends basic_event_emitter_1.default{database;custom;tables=new Map;constructor(custom,database){super();this.database=database;this.custom=new custom(database)}async ready(callback){return this.custom.ready(()=>callback?.(this)??Promise.resolve(undefined))}async disconnect(){this.custom.disconnected=true;this.tables.forEach(table=>table.disconnect());this.tables.clear();this.emit("disconnect")}forTable(name,columns){return this.ready(()=>{if(this.custom.disconnected)throw new Error("Database is disconnected");let table=this.tables.get(name);if(!table){table=new Table_1.Table(this.custom,name,columns);this.tables.set(name,table)}return Promise.resolve(table)})}readyTable(name,columns){const table=typeof name==="string"&&this.tables.has(name)?Promise.resolve(this.tables.get(name)):typeof name==="string"&&columns?this.forTable(name,columns):name instanceof Promise?name:Promise.reject(new Error("Invalid arguments"));return{table:table,async ready(callback){const t=await table;if(!t)throw new Error("Table not found");return t.ready(callback)}}}table(name,columns){return this.readyTable(name,columns)}deleteTable(name){return this.ready(async()=>{if(this.custom.disconnected)throw new Error("Database is disconnected");await this.custom.deleteTable(name);this.tables.delete(name);this.emit("deleteTable",name)})}async deleteDatabase(){this.custom.disconnected=true;await this.custom.deleteDatabase();this.tables.forEach(table=>table.disconnect());this.tables.clear();this.emit("delete")}}exports.Database=Database},{"./Custom":1,"./Table":3,"./Types":4,"./Utils":5,"basic-event-emitter":7}],3:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.Table=void 0;const basic_event_emitter_1=__importDefault(require("basic-event-emitter"));const Utils_1=require("./Utils");class Table extends basic_event_emitter_1.default{custom;name;_disconnected=false;serialize;initialPromise;constructor(custom,name,columns){super();this.custom=custom;this.name=name;this.serialize=Object.keys(columns).reduce((acc,key)=>{acc[key]={type:(0,Utils_1.getDatatype)(columns[key].type),primaryKey:columns[key].primaryKey??false,autoIncrement:columns[key].autoIncrement??false,notNull:columns[key].notNull??false,default:columns[key].default,unique:columns[key].unique??false,check:columns[key].check};return acc},{});this.initialPromise=this.custom.createTable(name,this.serialize)}async disconnect(){this._disconnected=true}async ready(callback){if(this._disconnected)throw new Error("Database is disconnected");await this.initialPromise;return callback?await callback(this):undefined}getColumnType(key){return this.serialize[key].type}getColumns(){return this.serialize}wheres(...where){return where}selectAll(where,columns){return this.ready(()=>this.custom.selectAll(this.name,columns,where))}selectOne(where,columns){return this.ready(()=>this.custom.selectOne(this.name,columns,where))}selectFirst(by,where,columns){return this.ready(()=>this.custom.selectFirst(this.name,by,columns,where))}selectLast(by,where,columns){return this.ready(()=>this.custom.selectLast(this.name,by,columns,where))}exists(where){return this.ready(async()=>{const data=await this.custom.selectOne(this.name,undefined,where);return data!==null})}async insert(data){data=await(0,Utils_1.serializeData)(this.serialize,data);return this.ready(()=>this.custom.insert(this.name,data)).then(()=>{this.emit("insert",data);return Promise.resolve()})}async update(data,where){data=await(0,Utils_1.serializeData)(this.serialize,data,true);return this.ready(()=>this.custom.update(this.name,data,where)).then(()=>{this.emit("update",data,where);return Promise.resolve()})}delete(where){return this.ready(()=>this.custom.delete(this.name,where)).then(()=>{this.emit("delete",where);return Promise.resolve()})}length(where){return this.ready(()=>this.custom.length(this.name,where))}}exports.Table=Table},{"./Utils":5,"basic-event-emitter":7}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true})},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.serializeData=exports.verifyDatatype=exports.getDatatype=exports.Types=exports.Operators=void 0;exports.Operators={EQUAL:"=",NOT_EQUAL:"!=",GREATER_THAN:">",LESS_THAN:"<",GREATER_THAN_OR_EQUAL:">=",LESS_THAN_OR_EQUAL:"<=",BETWEEN:"BETWEEN",LIKE:"LIKE",IN:"IN"};exports.Types={TEXT:"",INTEGER:0,FLOAT:.1,BOOLEAN:true,DATETIME:new Date,BIGINT:BigInt(0),NULL:null};const getDatatype=value=>{if(value===null)return"NULL";if(typeof value==="string")return"TEXT";if(typeof value==="bigint")return"BIGINT";if(typeof value==="number")return parseInt(value.toString()).toString()===value.toString()?"INTEGER":"FLOAT";if(typeof value==="boolean")return"BOOLEAN";if(value instanceof Date)return"DATETIME";return"TEXT"};exports.getDatatype=getDatatype;const verifyDatatype=(value,type)=>{switch(type){case"TEXT":return typeof value==="string";case"INTEGER":return parseInt(value)===value;case"FLOAT":return parseFloat(value)===value;case"BOOLEAN":return typeof value==="boolean";case"DATETIME":return value instanceof Date;case"BIGINT":return typeof value==="bigint";case"NULL":return value===null}return false};exports.verifyDatatype=verifyDatatype;const serializeData=(serialize,data,isPartial=false)=>{return new Promise((resolve,reject)=>{for(const key in isPartial?data:serialize){if(!(key in data)){if(serialize[key].default!==undefined){data[key]=serialize[key].default}else if(!serialize[key].autoIncrement){return reject(new Error(`Missing column ${key}`))}}if(serialize[key].autoIncrement){delete data[key]}else{if(serialize[key].notNull&&(data[key]===null||data[key]===undefined))return reject(new Error(`Column ${key} cannot be null or undefined`));if(data[key]!==null&&data[key]!==undefined&&!(0,exports.verifyDatatype)(data[key],serialize[key].type))return reject(new Error(`Invalid datatype for column ${key}`));if(data[key]!==null&&data[key]!==undefined&&typeof serialize[key].check==="function"){try{const isValid=serialize[key].check(data[key]);if(isValid instanceof Error)return reject(isValid)}catch(e){const message="message"in e?e.message:"Invalid value, error thrown: "+String(e);return reject(new Error(message))}}}}resolve(data)})};exports.serializeData=serializeData},{}],6:[function(require,module,exports){"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(){var ownKeys=function(o){ownKeys=Object.getOwnPropertyNames||function(o){var ar=[];for(var k in o)if(Object.prototype.hasOwnProperty.call(o,k))ar[ar.length]=k;return ar};return ownKeys(o)};return function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k=ownKeys(mod),i=0;i<k.length;i++)if(k[i]!=="default")__createBinding(result,mod,k[i]);__setModuleDefault(result,mod);return result}}();var __exportStar=this&&this.__exportStar||function(m,exports){for(var p in m)if(p!=="default"&&!Object.prototype.hasOwnProperty.call(exports,p))__createBinding(exports,m,p)};Object.defineProperty(exports,"__esModule",{value:true});const Database=__importStar(require("./Database"));__exportStar(require("./Database"),exports);exports.default=Database},{"./Database":2}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.BasicEventEmitter=void 0;const _subscriptions=Symbol("subscriptions");const _oneTimeEvents=Symbol("oneTimeEvents");function runCallback(callback,...arg){callback(...arg)}class BasicEventEmitter{[_subscriptions];[_oneTimeEvents];_ready=false;constructor(){this[_subscriptions]=[];this[_oneTimeEvents]=new Map;this.on("internal_ready",()=>{this._ready=true})}async ready(callback){if(this._ready){const response=await callback?.();return Promise.resolve(response)}return new Promise(resolve=>{this.once("internal_ready",async()=>{const response=await callback?.();resolve(response)})})}get prepared(){return this._ready}set prepared(value){if(value===true){this.emit("internal_ready")}this._ready=value}clearEvents(){this[_subscriptions]=[];this[_oneTimeEvents].clear()}on(event,callback){if(this[_oneTimeEvents].has(event)){runCallback(callback,...this[_oneTimeEvents].get(event)??[])}else{this[_subscriptions].push({event:event,callback:callback,once:false})}const self=this;return{stop(){self.off(event,callback)},remove(){this.stop()}}}off(event,callback){this[_subscriptions]=this[_subscriptions].filter(s=>s.event!==event||callback&&s.callback!==callback);return this}once(event,callback){return new Promise(resolve=>{const ourCallback=(...arg)=>{const r=callback?.(...arg);resolve(r)};if(this[_oneTimeEvents].has(event)){runCallback(ourCallback,...this[_oneTimeEvents].get(event)??[])}else{this[_subscriptions].push({event:event,callback:ourCallback,once:true})}})}offOnce(event,callback){this[_subscriptions]=this[_subscriptions].filter(s=>s.event!==event||callback&&s.callback!==callback||!s.once);return this}emit(event,...arg){if(this[_oneTimeEvents].has(event)){throw new Error(`Event "${String(event)}" was supposed to be emitted only once`)}for(let i=0;i<this[_subscriptions].length;i++){const s=this[_subscriptions][i];if(s.event!==event){continue}runCallback(s.callback,...arg);if(s.once){this[_subscriptions].splice(i,1);i--}}return this}emitOnce(event,...arg){if(this[_oneTimeEvents].has(event)){throw new Error(`Event "${String(event)}" was supposed to be emitted only once`)}this.emit(event,...arg);this[_oneTimeEvents].set(event,arg);this.offOnce(event);return this}pipe(event,eventEmitter){return this.on(event,(...arg)=>{eventEmitter.emit(event,...arg)})}pipeOnce(event,eventEmitter){return this.once(event,(...arg)=>{eventEmitter.emitOnce(event,...arg)})}}exports.BasicEventEmitter=BasicEventEmitter;exports.default=BasicEventEmitter},{}]},{},[6])(6)});